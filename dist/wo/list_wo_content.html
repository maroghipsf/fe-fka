<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dashboard</title><link rel="shortcut icon" href="/assets/compiled/svg/favicon.svg" type="image/x-icon"><link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAiCAYAAADRcLDBAAAEs2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSJ2d78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLnNvbS9leGlmLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLnNvbS9waG90b3Nob3AvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLnNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1zbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgZXhpZjpQaXhlbFhEaW1lbnNpb249IjMzIgogICBleGlmOlBpeGVsWURpbWVuc2lvbj0iMzQiCiAgIGV4aWY6Q29sb3JTcGFjZT0iMSIKICAgdGlmZjpJbWFnZVdpZHRoPSIzMyIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMzQiCiAgIHRpZmY6UmVzb2x1dGlvblVuaXQ9IjIiCiAgIHRpZmY6WFJlc29sdXRpb249Ijk2LjAiCiAgIHRpZmY6WVJlc29sdXRpb249Ijk2LjAiCiAgIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiCiAgIHbob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIKICAgeG1wOk1vZGlmeURhdGU9IjIwMjItMDMtMzFUMTA6NTA6MjMrMDI6MDAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjItMDMtMzFUMTA6NTA6MjMrMDI6MDAiPgogICA8eG1wTU06SGlzdG9yeT4KICAgIDxyZGY6U2VxPgogICAgIDxyZGY6bGkKICAgICAgc3RFdnQ6YWN0aW9uPSJwcm9kdWNlZCIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWZmaW5pdHkgRGVzaWduZXIgMS4xMC4xIgogICAgICBzdEV2dDp3aGVuPSIyMDIyLTAzLTMxVDEwOjUwOjIzKzAyOjAwIi8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94cGFja2V0Pgpl57uAAAABgmlDQ1BzUkdCIElFQzYxOTY2LTIuMQAAKJF1kc8rRFEUxz9maORHo1hYKC9hISNGTWwsRn4VFmOUX5uZZ36oeTOv954kW2WrKLHxa8FfwFZZK0WkZClrYoOe87ypmWTO7dzzud97z+nec8ETzaiaWd4NWtYyIiNhZWZ2TvE946WZSjqoj6mmPjE1HKWkfdxR5sSbgFOr9Ll/rXoxYapQVik8oOqGJTwqPL5i6Q5vCzeo6dii8KlwpyEXFL519LjLLw6nXP5y2IhGBsFTJ6ykijhexGra0ITl5bRqmWU1fx/nJTWJ7PSUxBbxJkwijBBGYYwhBgnRQ7/MIQIE6ZIVJfK7f/MnyUmuKrPOKgZLpEhj0SnqslRPSEyKnpCRYdXp/9++msneoFu9JgwVT7b91ga+LfjetO3PQ9v+PgLvI1xkC/m5A+h7F32zoLXug38dzi4LWnwHzjeg8UGPGbFfySvuSSbh9QRqZ6H+Gqrm3Z7l9zm+h+iafNUV7O5Bu5z3L/wAdthn7QIme0YAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAJTSURBVFiF7Zi9axRBGIefEw2IdxFBRQsLWUTBaywSK4ubdSGVIY1Y6HZql8ZKCGIqwX/AYLmCgVQKfiDn7jZeEQMWfsSAHAiKqPiB5mIgELWYOW5vzc3O7niHhT/YZvY37/swM/vOzJbIqVq9uQ04CYwCI8AhYAlYAB4Dc7HnrOSJWcoJcBS4ARzQ2F4BZ2LPmTeNuykHwEWgkQGAet9QfiMZjUSt3hwD7psGTWgs9pwH1hC1enMYeA7sKwDxBqjGnvNdZzKZjqmCAKh+U1kmEwi3IEBbIsugnY5avTkEtIAtFhBrQCX2nLVehqyRqFoCAAwBh3WGLAhbgCRIYYinwLolwLqKUwwi9pxV4KUlxKKKUwxC6ZElRCPLYAJxGfhSEOCz6m8HEXvOB2CyIMSk6m8HoXQTmMkJcA2YNTHm3congOvATo3tE3A29pxbpnFzQSiQPcB55IFmFNgFfEQeahaAGZMpsIJIAZWAHcDX2HN+2cT6r39GxmvC9aPNwH5gO1BOPFuBVWAZue0vA9+A12EgjPadnhCuH1WAE8ivYAQ4ohKaagV4gvxi5oG7YSA2vApsCOH60WngKrA3R9IsvQUuhIGY00K4flQG7gHH/mLytB4C42EgfrQb0mV7us8AAMeBS8mGNMR4nwNamtBB7B4QRNdaS0M8GxDEog7iyoAguvJ0QYSBuAOcAt71Kfl7wA8DcTvZ2KtOlJEr+ByyQtqqhTyHTIeB+ONeqi3brh+VgIN0fohUgWGggizZFTplu12yW8iy/YLOGWMpDMTPXnl+Az9vj2HERYqPAAAAAElFTkSuQmCC" type="image/png"><link rel="stylesheet" href="/assets/compiled/css/app.css"><link rel="stylesheet" href="/assets/compiled/css/app-dark.css"><link rel="stylesheet" href="/assets/compiled/css/iconly.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><link rel="stylesheet" href="/assets/extensions/simple-datatables/style.css"><link rel="stylesheet" href="/assets/compiled/css/table-datatable.css"><style>.wo-card-container {
            margin-bottom: 2rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .wo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .wo-card-header h5 {
            margin-bottom: 0;
            color: #3f51b5; /* Primary color for WO title */
        }
        .event-table-responsive {
            overflow-x: auto;
        }
        .event-table th, .event-table td {
            white-space: nowrap; /* Prevent wrapping for event table */
        }</style></head><body><script src="/assets/static/js/initTheme.js"></script><div id="app"><div id="sidebar"><div class="sidebar-wrapper active"><div class="sidebar-header position-relative"><div class="d-flex justify-content-between align-items-center"><div class="logo d-flex align-items-center"><a href="/index.html"><img src="/assets/compiled/svg/logo.svg" alt="Logo"></a></div><!-- Logout icon di pojok kanan --><div><a id="logout-btn" title="Logout" class="d-inline-block"><i class="bi bi-box-arrow-right fs-4"></i></a></div><div class="sidebar-toggler x"><a href="#" class="sidebar-hide d-xl-none d-block"><i class="bi bi-x bi-middle"></i></a></div></div></div><div class="sidebar-menu"><ul class="menu"><!-- 1. Beranda (Dashboard) --><li class="sidebar-item"><a href="/index.html" class="sidebar-link"><i class="bi bi-house-door"></i> <span>Beranda</span></a></li><!-- 2. Keuangan --><li class="sidebar-title">Keuangan</li><li class="sidebar-item"><a href="/keuangan/ringkasan.html" class="sidebar-link"><i class="bi bi-bar-chart"></i> <span>Ringkasan Keuangan</span></a></li><li class="sidebar-item"><a href="/keuangan/riwayat-transaksi.html" class="sidebar-link"><i class="bi bi-clock-history"></i> <span>Riwayat Transaksi Bank</span></a></li><li class="sidebar-item"><a href="/keuangan/transfer-dana.html" class="sidebar-link"><i class="bi bi-arrow-left-right"></i> <span>Transfer Dana</span></a></li><li class="sidebar-item has-sub"><a href="#" class="sidebar-link"><i class="bi bi-graph-up"></i> <span>Laporan Keuangan</span></a><ul class="submenu"><li class="submenu-item"><a href="/keuangan/laporan-arus-kas.html" class="submenu-link">Laporan Arus Kas</a></li><li class="submenu-item"><a href="/keuangan/laporan-laba-rugi.html" class="submenu-link">Laporan Laba Rugi</a></li><li class="submenu-item"><a href="/keuangan/laporan-pengeluaran-wo.html" class="submenu-link">Laporan Pengeluaran WO</a></li><li class="submenu-item"><a href="/keuangan/laporan-pembayaran-invoice.html" class="submenu-link">Laporan Pembayaran Invoice</a></li></ul></li><!-- 3. Manajemen PO --><li class="sidebar-title">Manajemen PO</li><li class="sidebar-item"><a href="/po/po.html" class="sidebar-link"><i class="bi bi-file-earmark-text"></i> <span>Purchase Order (PO)</span></a></li><!-- <li class="sidebar-item">
                    <a href="/wo/daftar-wo.html" class="sidebar-link">
                        <i class="bi bi-truck"></i>
                        <span>Working Order (WO)</span>
                    </a>
                </li> --><!-- 4. Manajemen Invoice --><li class="sidebar-title">Manajemen Invoice</li><li class="sidebar-item"><a href="/invoice/daftar-invoice.html" class="sidebar-link"><i class="bi bi-receipt"></i> <span>Daftar Invoice</span></a></li><!-- 5. Data Master --><li class="sidebar-title">Data Master</li><li class="sidebar-item"><a href="/master/gudang.html" class="sidebar-link"><i class="bi bi-building"></i> <span>Manajemen Gudang</span></a></li><!-- <li class="sidebar-item">
                    <a href="/master/pemasok.html" class="sidebar-link">
                        <i class="bi bi-person-lines-fill"></i>
                        <span>Manajemen Pemasok</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="/master/item.html" class="sidebar-link">
                        <i class="bi bi-box"></i>
                        <span>Manajemen Item (Barang/Jasa)</span>
                    </a>
                </li> --><li class="sidebar-item"><a href="/master/akun-bank.html" class="sidebar-link"><i class="bi bi-bank"></i> <span>Manajemen Akun Bank</span></a></li><li class="sidebar-item"><a href="/master/manajemen-bunga.html" class="sidebar-link"><i class="bi bi-percent"></i> <span>Manajemen Bunga Bank</span></a></li><!-- 6. Pengaturan & Audit --><li class="sidebar-title">Pengaturan & Audit</li><li class="sidebar-item"><a href="/settings/users.html" class="sidebar-link"><i class="bi bi-people-fill"></i> <span>Manajemen Pengguna</span></a></li><li class="sidebar-item"><a href="/settings/roles.html" class="sidebar-link"><i class="bi bi-shield-lock"></i> <span>Manajemen Peran & Hak Akses</span></a></li><li class="sidebar-item"><a href="/settings/audit-trail.html" class="sidebar-link"><i class="bi bi-activity"></i> <span>Audit Trail</span></a></li><li class="sidebar-item"><a href="/settings/notifikasi.html" class="sidebar-link"><i class="bi bi-bell"></i> <span>Notifikasi</span></a></li></ul></div></div></div><div id="main"><header class="mb-3"><a href="#" class="burger-btn d-block d-xl-none"><i class="bi bi-justify fs-3"></i></a></header><div class="page-heading"><div class="page-title"><div class="row"><div class="col-12 col-md-6 order-md-1 order-last"><h3 id="page-title-wo-list">Detail Working Orders untuk PO: <span id="po-display-id"></span></h3></div><div class="col-12 col-md-6 order-md-2 order-first"><nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="/index.html">Dashboard</a></li><li class="breadcrumb-item"><a href="/po.html">List Purchase Order</a></li><li class="breadcrumb-item active" aria-current="page">Detail Working Orders</li></ol></nav></div></div></div><section id="wo-list-section"><div class="row"><div class="col-12"><div class="card"><div class="card-content"><div class="card-body"><p><strong>Project:</strong> <span id="po-project"></span></p><p><strong>SDIP Nomor:</strong> <span id="po-sdip-no"></span></p><div id="wo-cards-container"><p id="no-wo-message" style="display: none; text-align: center; color: #888;">Tidak ada Working Order untuk Purchase Order ini.</p></div><div class="row mt-4"><div class="col-12 d-flex justify-content-end"><button type="button" class="btn btn-light-secondary me-1 mb-1" onclick="window.close()">Tutup</button></div></div></div></div></div></div></div></section></div><footer><div class="footer clearfix mb-0 text-muted"><div class="float-start"><p>2023 &copy; Mazer</p></div><div class="float-end"><p>Crafted with <span class="text-danger"><i class="bi bi-heart-fill icon-mid"></i></span> by <a href="https://saugi.me">Saugi</a></p></div></div></footer></div></div><script src="/assets/static/js/components/dark.js"></script><script src="/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script><script src="/assets/compiled/js/app.js"></script><script src="/assets/static/js/auth-guard.js"></script><script>$(document).on('click', '#logout-btn', function(e) {
    e.preventDefault();
    localStorage.removeItem('token');
    window.location.href = '/auth-login.html';
  });</script><script src="/assets/static/js/pages/form-element-select.js"></script><script src="/assets/extensions/simple-datatables/umd/simple-datatables.js"></script><script src="/assets/static/js/pages/simple-datatables.js"></script><script src="/assets/extensions/jquery/jquery.min.js"></script><script src="/assets/extensions/parsleyjs/parsley.min.js"></script><script src="/assets/static/js/pages/parsley.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script><script>const API_BASE_URL = 'http://localhost:3000/api';
        const TOKEN = localStorage.getItem('token');
        let allWarehouses = [];

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        async function fetchWarehouses() {
            try {
                const response = await fetch(`${API_BASE_URL}/warehouses`, {
                    headers: { 'Authorization': 'Bearer ' + TOKEN }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                const warehouseData = await response.json();
                allWarehouses = warehouseData.data && Array.isArray(warehouseData.data) ? warehouseData.data : [];
            } catch (err) {
                console.error("Error fetching warehouses:", err);
                Swal.fire('Error', `Gagal memuat data gudang: ${err.message || ''}.`, 'error');
            }
        }

        function getWarehouseName(warehouseId) {
            const warehouse = allWarehouses.find(wh => wh.warehouse_id === warehouseId);
            return warehouse ? warehouse.warehouse_name : 'Tidak Dikenal';
        }

        async function loadWODetails(poId) {
            await fetchWarehouses(); // Load warehouses first

            try {
                // Fetch PO details
                const poResponse = await fetch(`${API_BASE_URL}/purchase-orders/${poId}`, {
                    headers: { 'Authorization': 'Bearer ' + TOKEN }
                });

                if (!poResponse.ok) {
                    const errorData = await poResponse.json();
                    throw new Error(errorData.message || `Failed to fetch PO details: ${poResponse.status}`);
                }
                const poData = await poResponse.json();
                if (poData.data && poData.data.length > 0) {
                    const po = poData.data[0];
                    $('#po-display-id').text(po.po_id || '-');
                    $('#po-project').text(po.project || '-');
                    $('#po-sdip-no').text(po.sdip_no || '-');
                } else {
                    $('#po-display-id').text('Tidak Ditemukan');
                    Swal.fire('Informasi', 'Detail Purchase Order tidak ditemukan.', 'info');
                    return;
                }

                // Fetch Working Orders for this PO
                const woResponse = await fetch(`${API_BASE_URL}/working-orders/${poId}`, {
                    headers: { 'Authorization': 'Bearer ' + TOKEN }
                });

                if (!woResponse.ok) {
                    const errorData = await woResponse.json();
                    throw new Error(errorData.message || `HTTP error! status: ${woResponse.status}`);
                }

                const woResult = await woResponse.json();
                const woCardsContainer = $('#wo-cards-container');
                woCardsContainer.empty(); // Clear previous content

                if (woResult.data && woResult.data.length > 0) {
                    for (const wo of woResult.data) {
                        let eventsHtml = '';
                        // Fetch logistic events for each WO
                        const eventsResponse = await fetch(`${API_BASE_URL}/wo-logistic-events?wo_id=${wo.wo_id}`, {
                            headers: { 'Authorization': 'Bearer ' + TOKEN }
                        });

                        if (eventsResponse.ok) {
                            const eventsResult = await eventsResponse.json();
                            if (eventsResult.data && eventsResult.data.length > 0) {
                                eventsResult.data.sort((a, b) => new Date(b.event_timestamp) - new Date(a.event_timestamp)); // Sort by latest
                                eventsHtml = `
                                    <div class="event-table-responsive">
                                        <table class="table table-striped event-table">
                                            <thead>
                                                <tr>
                                                    <th>Tanggal/Waktu</th>
                                                    <th>Jenis Event</th>
                                                    <th>Lokasi</th>
                                                    <th>Catatan</th>
                                                    <th>Berat Bruto (kg)</th>
                                                    <th>Pihak Bertanggung Jawab</th>
                                                    <th>Tanda Tangan</th>
                                                    <th>Foto</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                eventsResult.data.forEach(event => {
                                    eventsHtml += `
                                        <tr>
                                            <td>${formatDateTime(event.event_timestamp)}</td>
                                            <td>${event.event_type || '-'}</td>
                                            <td>${event.location || '-'}</td>
                                            <td>${event.additional_notes || '-'}</td>
                                            <td>${event.gross_weight_kg != null ? event.gross_weight_kg : '-'}</td>
                                            <td>${event.responsible_party || '-'}</td>
                                            <td>${event.signature_url ? `<a href="${event.signature_url}" target="_blank">Lihat</a>` : '-'}</td>
                                            <td>${event.photo_url ? `<a href="${event.photo_url}" target="_blank">Lihat</a>` : '-'}</td>
                                        </tr>
                                    `;
                                });
                                eventsHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            } else {
                                eventsHtml = '<p class="text-center text-muted mt-3">Tidak ada riwayat event logistik untuk WO ini.</p>';
                            }
                        } else {
                            console.error(`Error fetching logistic events for WO ${wo.wo_id}:`, await eventsResponse.json());
                            eventsHtml = '<p class="text-center text-danger mt-3">Gagal memuat riwayat event logistik.</p>';
                        }

                        // Append WO card
                        woCardsContainer.append(`
                            <div class="wo-card-container">
                                <div class="wo-card-header">
                                    <h5>Working Order ID: ${wo.wo_id}</h5>
                                    <div>
                                        <button class="btn btn-sm btn-info me-2" title="Update WO ini" onclick="openUpdateWOFormSpecific('${wo.wo_id}')">
                                            <i class="bi bi-arrow-clockwise"></i> Update WO Ini
                                        </button>
                                        </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 col-12">
                                        <p><strong>Gudang Pengirim:</strong> ${getWarehouseName(wo.sender_warehouse_id)}</p>
                                        <p><strong>Gudang Penerima:</strong> ${getWarehouseName(wo.receiver_warehouse_id)}</p>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <p><strong>Tanggal Pickup Dijadwalkan:</strong> ${formatDate(wo.scheduled_pickup_time)}</p>
                                        <p><strong>Party:</strong> ${wo.net_weight_kg || '-'}</p>
                                    </div>
                                </div>
                                <h6 class="mt-4">Riwayat Event Logistik:</h6>
                                ${eventsHtml}
                            </div>
                        `);

                         // Initialize DataTables if you're using it for these tables
                         // Note: simple-datatables might need unique IDs or to be re-initialized carefully
                        // if (typeof simpleDatatables !== 'undefined') {
                        //     new simpleDatatables.DataTable(`#wo-cards-container .event-table`, {
                        //         sortable: true,
                        //         searchable: true,
                        //         // ... other options
                        //     });
                        // }
                    }
                } else {
                    $('#no-wo-message').show(); // Show message if no WOs
                }
            } catch (err) {
                console.error("Error fetching WO details for display:", err);
                Swal.fire('Error', `Gagal memuat detail Working Orders: ${err.message || ''}.`, 'error');
                $('#wo-cards-container').html('<p class="text-center text-danger mt-3">Gagal memuat data detail Working Orders.</p>');
            }
        }

        // Function to open update form for a specific WO_ID (useful from list_wo_content)
        function openUpdateWOFormSpecific(woId) {
            window.open(`/wo/form_wo_content.html?wo_id=${woId}`, '_blank');
        }

        $(document).ready(function() {
            const poId = getQueryParam('po_id');
            if (poId) {
                loadWODetails(poId);
            } else {
                Swal.fire('Error', 'ID Purchase Order tidak ditemukan.', 'error')
                    .then(() => {
                        window.close();
                    });
            }
        });</script></body></html>